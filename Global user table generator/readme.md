# Global user data generator

## What this is

This section contains the source code for a program that takes in a folder containing details about user edit counts on various wikis, and outputs 

* a full table (spreadsheet-style) that collates the edits users made in each wiki
* an analytical table that ranks the _global_ edits of each user.

In addition, this information is published on Meta-Wiki, at https://meta.wikimedia.org/w/index.php?title=Global_statistics. The source code for this is available at ``pushtowiki.py``; for that, you need a file called ``botdetails.txt`` with (in separate lines) the API page of the wiki you plan to go to, the bot username and password, and the place you want the bot to print its results to. In this case the data would be 

```
https://meta.wikimedia.org/w/api.php
Leaderbot@Statistics_generator [replace with bot username obtained from Special:BotPasswords]
[bot password]
Global statistics/
```

## Getting started

The first step is to get the number of edits each user made on each wiki (or the wikis you chose). On [Toolforge](https://wikitech.wikimedia.org/wiki/Help:Toolforge), set up a [job](https://wikitech.wikimedia.org/wiki/Help:Toolforge/Grid) to do this. Create a script (see `scripter.sh` in the root) that does the below:

```bash
for((i=1;i<=$#;i++)); 
do mysql --defaults-file=$HOME/replica.my.cnf -h ${!i}.analytics.db.svc.wikimedia.cloud ${!i}_p -e "SELECT user_name, user_registration, user_editcount from user;" > ${!i}.csv; 
done
```

What this does for each wiki you specify in the argument, it accesses the relevant database and runs an SQL query that gets the user edit count for each user in the database (which can be 0). Note that the reason the grid is used is otherwise it can get "killed" by an out-of-memory error. Make sure to allocate at least 20 GB or so for the job you set up; it will run out of memory otherwise. 

To run this script for all wikis, you'll need a list of all wikis in the SUL (946 as of writing). The below should help:

```bash
time ./scripter.sh aawiki aawikibooks aawiktionary abwiki abwiktionary acewiki advisorywiki adywiki afwiki afwikibooks afwikiquote afwiktionary akwiki akwikibooks akwiktionary alswiki altwiki amiwiki amwiki amwikimedia amwikiquote amwiktionary angwiki angwikibooks angwikiquote angwikisource angwiktionary anpwiki anwiki anwiktionary apiportalwiki arcwiki arwiki arwikibooks arwikimedia arwikinews arwikiquote arwikisource arwikiversity arwiktionary arywiki arzwiki astwiki astwikibooks astwikiquote astwiktionary aswiki aswikibooks aswikiquote aswikisource aswiktionary atjwiki avkwiki avwiki avwiktionary awawiki aywiki aywikibooks aywiktionary azbwiki azwiki azwikibooks azwikimedia azwikiquote azwikisource azwiktionary banwiki banwikisource barwiki bat_smgwiki bawiki bawikibooks bclwiki bclwikiquote bclwiktionary bdwikimedia betawikiversity bewiki bewikibooks bewikimedia bewikiquote bewikisource bewiktionary be_x_oldwiki bgwiki bgwikibooks bgwikinews bgwikiquote bgwikisource bgwiktionary bhwiki bhwiktionary biwiki biwikibooks biwiktionary bjnwiki bjnwiktionary blkwiki bmwiki bmwikibooks bmwikiquote bmwiktionary bnwiki bnwikibooks bnwikiquote bnwikisource bnwikivoyage bnwiktionary bowiki bowikibooks bowiktionary bpywiki brwiki brwikimedia brwikiquote brwikisource brwiktionary bswiki bswikibooks bswikinews bswikiquote bswikisource bswiktionary bugwiki bxrwiki cawiki cawikibooks cawikimedia cawikinews cawikiquote cawikisource cawiktionary cbk_zamwiki cdowiki cebwiki cewiki chowiki chrwiki chrwiktionary chwiki chwikibooks chwiktionary chywiki ckbwiki ckbwiktionary cnwikimedia commonswiki cowiki cowikibooks cowikimedia cowikiquote cowiktionary crhwiki crwiki crwikiquote crwiktionary csbwiki csbwiktionary cswiki cswikibooks cswikinews cswikiquote cswikisource cswikiversity cswiktionary cuwiki cvwiki cvwikibooks cywiki cywikibooks cywikiquote cywikisource cywiktionary dagwiki dawiki dawikibooks dawikiquote dawikisource dawiktionary dewiki dewikibooks dewikinews dewikiquote dewikisource dewikiversity dewikivoyage dewiktionary dinwiki diqwiki diqwiktionary dkwikimedia donatewiki dsbwiki dtywiki dvwiki dvwiktionary dzwiki dzwiktionary eewiki elwiki elwikibooks elwikinews elwikiquote elwikisource elwikiversity elwikivoyage elwiktionary emlwiki enwiki enwikibooks enwikinews enwikiquote enwikisource enwikiversity enwikivoyage enwiktionary eowiki eowikibooks eowikinews eowikiquote eowikisource eowikivoyage eowiktionary eswiki eswikibooks eswikinews eswikiquote eswikisource eswikiversity eswikivoyage eswiktionary etwiki etwikibooks etwikimedia etwikiquote etwikisource etwiktionary euwiki euwikibooks euwikiquote euwikisource euwiktionary extwiki fatwiki fawiki fawikibooks fawikinews fawikiquote fawikisource fawikivoyage fawiktionary ffwiki fiu_vrowiki fiwiki fiwikibooks fiwikimedia fiwikinews fiwikiquote fiwikisource fiwikiversity fiwikivoyage fiwiktionary fjwiki fjwiktionary foundationwiki fowiki fowikisource fowiktionary frpwiki frrwiki frwiki frwikibooks frwikinews frwikiquote frwikisource frwikiversity frwikivoyage frwiktionary furwiki fywiki fywikibooks fywiktionary gagwiki ganwiki gawiki gawikibooks gawikiquote gawiktionary gcrwiki gdwiki gdwiktionary gewikimedia glkwiki glwiki glwikibooks glwikiquote glwikisource glwiktionary gnwiki gnwikibooks gnwiktionary gomwiki gomwiktionary gorwiki gorwiktionary gotwiki gotwikibooks grwikimedia gucwiki gurwiki guwiki guwikibooks guwikiquote guwikisource guwiktionary guwwiki guwwikinews guwwikiquote guwwiktionary gvwiki gvwiktionary hakwiki hawiki hawiktionary hawwiki hewiki hewikibooks hewikinews hewikiquote hewikisource hewikivoyage hewiktionary hifwiki hifwiktionary hiwiki hiwikibooks hiwikimedia hiwikiquote hiwikisource hiwikiversity hiwikivoyage hiwiktionary howiki hrwiki hrwikibooks hrwikiquote hrwikisource hrwiktionary hsbwiki hsbwiktionary htwiki htwikisource huwiki huwikibooks huwikinews huwikiquote huwikisource huwiktionary hywiki hywikibooks hywikiquote hywikisource hywiktionary hywwiki hzwiki iawiki iawikibooks iawiktionary idwiki idwikibooks idwikimedia idwikiquote idwikisource idwiktionary iewiki iewikibooks iewiktionary igwiki igwikiquote igwiktionary iiwiki ikwiki ikwiktionary ilowiki incubatorwiki inhwiki iowiki iowiktionary iswiki iswikibooks iswikiquote iswikisource iswiktionary itwiki itwikibooks itwikinews itwikiquote itwikisource itwikiversity itwikivoyage itwiktionary iuwiki iuwiktionary jamwiki jawiki jawikibooks jawikinews jawikiquote jawikisource jawikiversity jawikivoyage jawiktionary jbowiki jbowiktionary jvwiki jvwikisource jvwiktionary kaawiki kabwiki kawiki kawikibooks kawikiquote kawiktionary kbdwiki kbdwiktionary kbpwiki kcgwiki kcgwiktionary kgwiki kiwiki kjwiki kkwiki kkwikibooks kkwikiquote kkwiktionary klwiki klwiktionary kmwiki kmwikibooks kmwiktionary knwiki knwikibooks knwikiquote knwikisource knwiktionary koiwiki kowiki kowikibooks kowikinews kowikiquote kowikisource kowikiversity kowiktionary krcwiki krwiki krwikiquote kshwiki kswiki kswikibooks kswikiquote kswiktionary kuwiki kuwikibooks kuwikiquote kuwiktionary kvwiki kwwiki kwwikiquote kwwiktionary kywiki kywikibooks kywikiquote kywiktionary labswiki ladwiki lawiki lawikibooks lawikiquote lawikisource lawiktionary lbewiki lbwiki lbwikibooks lbwikiquote lbwiktionary lezwiki lfnwiki lgwiki lijwiki lijwikisource liwiki liwikibooks liwikinews liwikiquote liwikisource liwiktionary lldwiki lmowiki lmowiktionary lnwiki lnwikibooks lnwiktionary loginwiki lowiki lowiktionary lrcwiki ltgwiki ltwiki ltwikibooks ltwikiquote ltwikisource ltwiktionary lvwiki lvwikibooks lvwiktionary madwiki maiwiki maiwikimedia map_bmswiki mdfwiki mediawikiwiki metawiki mgwiki mgwikibooks mgwiktionary mhrwiki mhwiki mhwiktionary minwiki minwiktionary miwiki miwikibooks miwiktionary mkwiki mkwikibooks mkwikimedia mkwikisource mkwiktionary mlwiki mlwikibooks mlwikiquote mlwikisource mlwiktionary mniwiki mniwiktionary mnwiki mnwikibooks mnwiktionary mnwwiki mnwwiktionary mrjwiki mrwiki mrwikibooks mrwikiquote mrwikisource mrwiktionary mswiki mswikibooks mswiktionary mtwiki mtwiktionary muswiki mwlwiki mxwikimedia myvwiki mywiki mywikibooks mywiktionary mznwiki nahwiki nahwikibooks nahwiktionary napwiki napwikisource nawiki nawikibooks nawikiquote nawiktionary ndswiki ndswikibooks ndswikiquote ndswiktionary nds_nlwiki newiki newikibooks newiktionary newwiki ngwiki ngwikimedia niawiki niawiktionary nlwiki nlwikibooks nlwikimedia nlwikinews nlwikiquote nlwikisource nlwikivoyage nlwiktionary nnwiki nnwikiquote nnwiktionary nostalgiawiki novwiki nowiki nowikibooks nowikimedia nowikinews nowikiquote nowikisource nowiktionary nqowiki nrmwiki nsowiki nvwiki nycwikimedia nywiki nzwikimedia ocwiki ocwikibooks ocwiktionary olowiki omwiki omwiktionary orwiki orwikisource orwiktionary oswiki outreachwiki pagwiki pamwiki papwiki pawiki pawikibooks pawikisource pawiktionary pa_uswikimedia pcdwiki pcmwiki pdcwiki pflwiki pihwiki piwiki piwiktionary plwiki plwikibooks plwikimedia plwikinews plwikiquote plwikisource plwikivoyage plwiktionary pmswiki pmswikisource pnbwiki pnbwiktionary pntwiki pswiki pswikibooks pswikivoyage pswiktionary ptwiki ptwikibooks ptwikimedia ptwikinews ptwikiquote ptwikisource ptwikiversity ptwikivoyage ptwiktionary punjabiwikimedia pwnwiki qualitywiki quwiki quwikibooks quwikiquote quwiktionary rmwiki rmwikibooks rmwiktionary rmywiki rnwiki rnwiktionary roa_rupwiki roa_rupwiktionary roa_tarawiki romdwikimedia rowiki rowikibooks rowikinews rowikiquote rowikisource rowikivoyage rowiktionary rswikimedia ruewiki ruwiki ruwikibooks ruwikimedia ruwikinews ruwikiquote ruwikisource ruwikiversity ruwikivoyage ruwiktionary rwwiki rwwiktionary sahwiki sahwikiquote sahwikisource satwiki sawiki sawikibooks sawikiquote sawikisource sawiktionary scnwiki scnwiktionary scowiki scwiki scwiktionary sdwiki sdwikinews sdwiktionary sewiki sewikibooks sewikimedia sgwiki sgwiktionary shiwiki shnwiki shnwikibooks shnwikivoyage shnwiktionary shwiki shwiktionary shywiktionary simplewiki simplewikibooks simplewikiquote simplewiktionary siwiki siwikibooks siwiktionary skrwiki skrwiktionary skwiki skwikibooks skwikiquote skwikisource skwiktionary slwiki slwikibooks slwikiquote slwikisource slwikiversity slwiktionary smnwiki smwiki smwiktionary snwiki snwiktionary sourceswiki sowiki sowiktionary specieswiki sqwiki sqwikibooks sqwikinews sqwikiquote sqwiktionary srnwiki srwiki srwikibooks srwikinews srwikiquote srwikisource srwiktionary sswiki sswiktionary stqwiki strategywiki stwiki stwiktionary suwiki suwikibooks suwikiquote suwiktionary svwiki svwikibooks svwikinews svwikiquote svwikisource svwikiversity svwikivoyage svwiktionary swwiki swwikibooks swwiktionary szlwiki szywiki tawiki tawikibooks tawikinews tawikiquote tawikisource tawiktionary taywiki tcywiki tenwiki test2wiki testcommonswiki testwiki testwikidatawiki tetwiki tewiki tewikibooks tewikiquote tewikisource tewiktionary tgwiki tgwikibooks tgwiktionary thankyouwiki thwiki thwikibooks thwikinews thwikiquote thwikisource thwiktionary tiwiki tiwiktionary tkwiki tkwikibooks tkwikiquote tkwiktionary tlwiki tlwikibooks tlwikiquote tlwiktionary tnwiki tnwiktionary towiki towiktionary tpiwiki tpiwiktionary trvwiki trwiki trwikibooks trwikimedia trwikinews trwikiquote trwikisource trwikivoyage trwiktionary tswiki tswiktionary ttwiki ttwikibooks ttwikiquote ttwiktionary tumwiki twwiki twwiktionary tyvwiki tywiki uawikimedia udmwiki ugwiki ugwikibooks ugwikiquote ugwiktionary ukwiki ukwikibooks ukwikinews ukwikiquote ukwikisource ukwikivoyage ukwiktionary urwiki urwikibooks urwikiquote urwiktionary usabilitywiki uzwiki uzwikibooks uzwikiquote uzwiktionary vecwiki vecwikisource vecwiktionary vepwiki vewiki vewikimedia viwiki viwikibooks viwikiquote viwikisource viwikivoyage viwiktionary vlswiki votewiki vowiki vowikibooks vowikiquote vowiktionary warwiki wawiki wawikibooks wawikisource wawiktionary wbwikimedia wikidatawiki wikimania2005wiki wikimania2006wiki wikimania2007wiki wikimania2008wiki wikimania2009wiki wikimania2010wiki wikimania2011wiki wikimania2012wiki wikimania2013wiki wikimania2014wiki wikimania2015wiki wikimania2016wiki wikimania2017wiki wikimania2018wiki wikimaniawiki wowiki wowikiquote wowiktionary wuuwiki xalwiki xhwiki xhwikibooks xhwiktionary xmfwiki yiwiki yiwikisource yiwiktionary yowiki yowikibooks yowiktionary yuewiktionary zawiki zawikibooks zawikiquote zawiktionary zeawiki zhwiki zhwikibooks zhwikinews zhwikiquote zhwikisource zhwikiversity zhwikivoyage zhwiktionary zh_classicalwiki zh_min_nanwiki zh_min_nanwikibooks zh_min_nanwikiquote zh_min_nanwikisource zh_min_nanwiktionary zh_yuewiki zuwiki zuwikibooks zuwiktionary
```

This can be obtained by finding the list of SUL wikis at https://db-names.toolforge.org/, copying over to Excel, and using Excel's `TRANSPOSE` function to change from vertical to horizontal. 

If you are using Toolforge, you will need to use `time jsub -mem 20g -cwd -stderr scripter.sh` instead. This allows us to set tje job parameters properly. 

It should complete in a few minutes. 
## Running the program

First change the directory where the individual files are located (that is, the ``loc`` variable), and where the two files should be output to (make the appropriate adjustments in ``setStream``). Then, there are two ways to go about this:

* using Maven: run `time mvn compile exec:java -Dexec.mainClass="Main"` from the "Global user table generator" folder. 
* manually (required if you are using Toolforge as Maven seems to fail with an error): go to the `src/main/java` folder. Then run

```bash
javac -cp .:../../../lib/trove4j-3.0.3.jar Main.java
java java -cp .:../../../lib/trove4j-3.0.3.jar:../../../lib/guice-5.1.0.jar Main-Xmx25000M Main
```

Assuming this is for the full set, it will take 

* about 10 minutes to import
* about a few minutes to generate the collated table listing every user's total number of edits across all wikis, sorted
* a few hours to generate the large matrix showing each user's contribution across every wiki.

It will use a lot of memory (can get up to ~25 GB for the full set). If ``-Xmx25000M`` is not set, you will likely get the below error message: ``Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread "main"``. As above, if you are running on Toolforge, set up a job rather than running from the terminal, allocating an appropriate amount of memory to the job as before. 

## Accessing the results

Once it fully runs, it will output two files as described above. In many cases you cannot use Excel to view the full contents - it can only display the first 1048576 rows of the file - [Gnumeric does better, but even its ~16 million row limit won't always be enough](https://help.gnome.org/users/gnumeric/stable/sect-worksheets-display.html.en). You will need to use tools such as SPSS instead. Note that the column separator is a pipe (|).
